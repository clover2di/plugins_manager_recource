# Interactive Board — актуальный обзор, статус и предложения по улучшениям

Дата: 2025‑08‑23

## 1) Краткий обзор

Плагин‑доска для OnlyOffice/R7 с полноэкранной областью рисования, панорамированием, векторными фигурами и изображениями, локализацией и тёмной темой. Рендер через два offscreen‑слоя (world для пикселей и shapes для фигур) с учётом DPR и pan, композиция в видимый canvas. Диалоги подтверждения — стандартные HTML5 с доступностью (ARIA, фокус‑ловушка).

## 2) Текущие возможности (сводка)

- Инструменты: Карандаш, Маркер (превью на оверлее → коммит), Ластик, Фигуры (круг/треугольник/квадрат/звезда/линия), Стрелка, Текст (многострочный + стиль), Рука (pan), Курсор (выделение/перемещение/масштаб/поворот/удаление), Изображение.
- Изображения: центрирование при вставке, адаптивный даунскейл (createImageBitmap приоритетно) с ограничением целевого размера под вьюпорт, сохранение пропорций при ресайзе, вращение, «удалить» закреплён в пределах видимой области.
- Вставка изображений из буфера обмена: глобальный handler, поддержка image/file, clipboard items и data:image из HTML/текста; защита от двойной обработки. ГОТОВО.
- Полноэкранный режим: восстановление после системного диалога выбора файла (focus/gesture fallback). ГОТОВО.
- Отрисовка: offscreen world (штрихи), offscreen shapes (векторы/текст/изображения), композиция в видимый canvas; фоновые шаблоны (база/точки/сетка/линии) синхронизированы с pan и масштабом.
- История: Undo/Redo со снапшотами world + клон списка векторов; интеграция с Cursor/Shapes/Image/Text; кнопки «Отменить/Повторить» синхронизируются.
- Локализация: автоопределение языка (OnlyOffice → browser), устойчивый загрузчик словарей (timeouts+retry+кэш last‑good), применение к title/aria/диалогам.
- Тема/иконки: inline SVG, currentColor; монтирование сразу, ретонинг отложен через requestIdleCallback. ГОТОВО.
- Диалоги: «Очистить» и «Закрыть» — локализованы, с фокус‑ловушкой/автофокусом и возвратом фокуса инициатору.
- Доступность/подсказки: нативные title‑подсказки автоматически подавляются, если открыт любой поповер; подсказки для цветовых палитр не навязчивы (без title, есть aria‑label). ГОТОВО.
- Экспорт/вставка: PNG‑снимок видимой сцены; вставка в Document/Presentation/Sheet с безопасными обёртками API и toasts.
- Горячие клавиши: Delete/Backspace — удалить выбранный объект. ГОТОВО.
- Диагностика: централизованный логгер уровней (debug/info/warn/error/silent) с toasts и bridge; стартовый feature‑audit в window.__IB_FEATURE_AUDIT__.
- Управление памятью изображений: при удалении/очистке фигуры‑изображения закрывается ImageBitmap (или создаётся и сразу закрывается), URL очищается. ГОТОВО.

## 3) Ключевые технические детали

- Слои: worldCanvas и shapesCanvas (оба offscreen) масштабируются под DPR и смещаются pan’ом; overlay‑canvas для превью/ручек.
- Рост «мира»: ensureCapacity() удваивает размеры по мере подхода к краям, но жёстко ограничен MAX 16K px на сторону в device‑px, с мягким клампингом pan и единоразовым уведомлением. ГОТОВО.
- Производительность: rAF‑троттлинг оверлея в Marker и Cursor; deferred иконки; минимальные DEBUG‑крошки.
- Управление ресурсами: revokeObjectURL после успешного даунскейла/bitmap; предпочтение createImageBitmap для декода/resize. ГОТОВО.

## 4) Соответствие внутренним стандартам

- 14_flexible_windows_guide: resizeWindow, 100% макет, onThemeChangedBase — соблюдено.
- 15_modal_close_button_guide: подтверждение закрытия с fallback на Asc.plugin.button/executeCommand — соблюдено.
- 16_global_variables_plugin_context_guide: критические состояния на window; мосты через Asc.scope — соблюдено.
- 17_async_context_defensive_patterns: таймауты/AbortController/ретраи для i18n; кэш last‑good; try/catch в чувствительных местах — соблюдено.
- 18_onlyoffice_api_compatibility_guide: безопасные вызовы StartAction/EndAction/executeMethod/callCommand; feature‑audit — соблюдено.

Итог: соответствие хорошее, критичных пробелов нет.

## 5) Недавние изменения и исправления

- Восстановление полноэкранного режима после выбора файла изображения. ГОТОВО.
- Вставка изображений из буфера обмена, в т.ч. data:image, и предотвращение двукратной вставки. ГОТОВО.
- Подавление title‑подсказок при открытых поповерах; удаления «подсказок‑тостов» про инструменты. ГОТОВО.
- Delete/Backspace удаляет выделение с Undo‑снапшотом и перерисовкой. ГОТОВО.
- ARIA для тостов (assertive для ошибок), контейнер region/polite. ГОТОВО.

## 6) Узкие места и риски (после актуализации)

- Экспорт только в PNG из UI. JPEG/качество пока отсутствует.
- Несколько строк всё ещё жёстко зашиты вне словарей (например, имя файла «board.png», aria‑label контейнера тостов «Notifications» и пр.).
- Клавиатурная доступность для цветовых swatch’ей: им назначены role=button/tabindex, но нет явной обработки Enter/Space — стоит добавить для надёжности.
- История фона/панорамирования не входит в Undo/Redo (осознанно). При необходимости точной реставрации сцены — опционально сохранить.

## 7) Предложения по улучшениям (приоритеты)

Высокий:
1) Экспорт JPEG: добавить выбор формата (PNG/JPEG) и ползунок качества (по умолчанию 0.8); i18n строк и сохранение последнего выбора. Изменения: `scripts/export.js` (поддержка quality), `index.html` (UI), `translations/*`.
2) I18n‑добивка: вынести остаточные литералы (имя файла, aria‑label тостов, подписи слайдера фона) и добавить ключи, например: toast.deleted_selection, toast.world_limit, aria.notifications, file.default_name. Синхронизировать ru‑RU/en‑US.

Средний:
3) Доступность: добавить keydown (Enter/Space) для swatch‑кнопок (поповеры Pencil/Marker/Shapes/Text) и для иконок выбора фона. Проверить курсор‑фокус в поповерах.
4) Персистентность настроек: ОТКЛОНЕНО. По решению — не сохраняем параметры инструментов и фона между сессиями; при новом открытии всё по умолчанию.

Низкий:
6) Вставка: drag‑and‑drop файлов на канвас (с теми же ограничениями даунскейла и revokeObjectURL).
7) Диагностика: компактная панель «Debug» (в dev) со счётчиками rAF, временем перерисовки и размерами world/shapes.

## 8) План итераций (коротко)

Итерация A (экспорт + i18n):
- UI выбора PNG/JPEG + качество, i18n строки, дефолт сохранения. Тест вставки в все типы редакторов.
- I18n‑свип: вынести оставшиеся литералы; добавить toast.deleted_selection/aria.notifications; обновить ru/en.

Итерация B (доступность + память):
- Enter/Space для swatch’ей и фона; минимальные ARIA‑атрибуты где нужно.
- Проверка отсутствия утечек памяти изображений после внедрения освобождения ресурсов.
- Персистентность настроек — не делаем (принято решение сбрасывать всё при закрытии).

## 9) Контроль качества (актуально)

- Линт/типизация: базовая проверка JS (опц.).
- Юнит/дымовое: Undo/Redo, вставка PNG/JPEG, paste/двойной paste, fullscreen после file‑диалога, рендер фонов, Delete/Backspace.
- Ручные края: огромные изображения (проверка даунскейла), долгие pan (предел 16K), смена темы, локали без сети (кэш last‑good).

## 10) Полная структура проекта

- about.html
- config.json
- features.md
- hostory.md
- index.html
- README.md
- translations/
	- en-US.json
	- ru-RU.json
- scripts/
	- canvas.js — инициализация размеров канваса, DPR‑трансформ, связка с Overlay и Background, дебаунс resize.
	- cursors.js — генерация курсоров (круг/штрих/квадрат) и применение по активному инструменту.
	- export.js — формирование снимка видимой сцены (PNG), подготовка к расширению JPEG/quality.
	- history.js — Undo/Redo: снапшоты world + перерисовка фигур, интеграция с Overlay.
	- i18n.js — применение словаря и функция t(path, def) для перевода.
	- icons.js — монтирование/ретонинг inline‑иконок (currentColor), загрузка svg из resources.
	- insert.js — вставка сгенерированного изображения в документ/презентацию/лист через OnlyOffice API.
	- logger.js — уровни логирования, тосты (ARIA), опц. bridge.
	- overlay.js — верхний прозрачный слой для превью/ручек, API ensureOverlay/clear/getMetrics.
	- plugin.js — глобальное состояние, маршрутизация событий мыши/тач, подключение инструментов, диалоги, i18n загрузка.
	- tool.arrow.js — инструмент «Стрелка»: отрисовка линии со стрелочным наконечником.
	- tool.backgroud.js — фоновые шаблоны (plain/grid/dots/ruled), масштаб/цвет; без персистентности.
	- tool.cursor.js — выделение/манипуляции фигурами, ручки, удаление, freeImageResources, redrawAllShapes.
	- tool.eraser.js — ластик: стирание штрихов на world‑слое, ширина.
	- tool.hand.js — панорамирование мира, обновление фона при движении.
	- tool.image.js — выбор файла/вставка из буфера, даунскейл/createImageBitmap, создание фигуры‑изображения.
	- tool.marker.js — маркер с превью на Overlay, коммит в world, ширина/цвет.
	- tool.pencil.js — карандаш (сразу пишет в world), ширина/цвет.
	- tool.shapes.js — простые фигуры (круг/квадрат/треугольник/звезда/линия), параметры цвета/толщины.
	- tool.text.js — многострочный текст, редактор, стиль (B/I/U), fontSize/color, измерение и отрисовка.
	- tools.js — UI поповеров инструментов и фона; без сохранения между сессиями; выключение title‑подсказок.
	- world.js — offscreen world/shapes, pan/resize, предел 16К, композиция в видимый canvas.
- resources/
	- css/
		- style.css
	- icons/
		- background_base.svg
		- background_dot.svg
		- background_grid.svg
		- background_lines.svg
		- icon.png
		- plugin_close.svg
		- plugin_fullscreen_off.svg
		- plugin_fullscreen_on.svg
		- plugin_leftpanel_close.svg
		- plugin_leftpanel_open.svg
		- plugin_redo.svg
		- plugin_save.svg
		- plugin_upload.svg
		- shapes_circle.svg
		- shapes_delete.svg
		- shapes_line.svg
		- shapes_square.svg
		- shapes_star.svg
		- shapes_triangle.svg
		- sheet_add.svg
		- sheet_delete.svg
		- tool_arrow.svg
		- tool_cursor.svg
		- tool_eraser.svg
		- tool_hand.svg
		- tool_image.svg
		- tool_marker.svg
		- tool_pencil.svg
		- tool_shapes.svg
		- tool_text.svg
		- tool_clear.svg
		- toolparameters_size_1.svg
		- toolparameters_size_2.svg
		- toolparameters_size_3.svg
		- toolparameters_size_4.svg
		- toolparameters_size_5.svg
		- dark/
			- icon.png
		- light/
			- icon.png

---

Краткое резюме: проект стал значительно устойчивее и дружелюбнее к пользователю (i18n с таймаутами/кэшем, rAF‑троттлинг, предел 16K, revokeObjectURL, доступные диалоги, paste изображений, восстановление fullscreen, подавление лишних подсказок). Рекомендуемые следующие шаги: добавить JPEG‑экспорт с качеством, добить i18n‑ключи, усилить клавиатурную доступность swatch’ей.

## 12) Оптимизация

Цель: сделать отрисовку плавной и снизить потребление ресурсов (CPU/GPU/память), чтобы карандаш не «отставал» даже на экранах высокой плотности (4K+).

Быстрые и малорисковые улучшения (начать с них)
- Единый present через rAF (одна композиция за кадр)
	- Проблема: `renderToVisible` дергается на каждом событии мыши.
	- Решение: добавить `schedulePresent()` с флагом `presentPending` и вызывать `BoardWorld.renderToVisible(ctx)` внутри `requestAnimationFrame`. Повторы до кадра игнорировать.
	- Где: `scripts/plugin.js` (заменить прямые вызовы на `schedulePresent()`).
- Батчинг карандаша/ластика через rAF + coalesced events
	- Накапливать точки из `PointerEvent.getCoalescedEvents()` (если доступно), рисовать 1 раз за кадр.
	- Добавить порог по расстоянию между точками (>= 1.5–2 CSS px) для прореживания.
	- Где: `scripts/tool.pencil.js`, `scripts/tool.eraser.js`.
- Сглаживание кривой и меньше stroke-операций
	- Вместо множества коротких отрезков — простая квадр. аппроксимация (last, mid, cur) и один `stroke()` на батч.
- Ограничение эффективного DPR
	- Проблема: 4K/5K взрывает число device‑px и полосу памяти.
	- Решение: ввести `renderScale = min(devicePixelRatio, 1.5..2.0)` и использовать его для всех canvas (видимый и world). UI в CSS остаётся нативным.
	- Где: `scripts/canvas.js`, `scripts/world.js`.
- Хинты контекста для видимого canvas
	- `getContext('2d', { alpha: false, desynchronized: true })` (fallback безопасен). `alpha:false` ускоряет композицию при непрозрачном фоне.
	- Где: `scripts/canvas.js`.
- Троттлинг оверлея и избегание полных очисток
	- Очищать только dirty‑области на overlay или вызывать очистку по rAF.

Средняя сложность, ощутимая выгода
- Меньше начальный размер «мира» и умнее рост
	- Уменьшить MULT c 3× до 2×; снизит стартовую память на ~33% на высоком DPR. Margins оставить щедрыми (200–300 CSS px).
	- Где: `scripts/world.js`.
- Композиция по «грязному» региону (dirty rect)
	- Трекать bbox правок и рисовать из world/shapes только подмножество видимой области. Сбрасывать/расширять при pan/zoom.
	- Где: `scripts/world.js` (`renderToVisible`) + передача dirty от инструментов.
- Политика перерисовки фигур/текста
	- shapesCanvas менять только при изменении векторов, а композитить в видимый canvas через `drawImage` без лишних пересчётов.
- Изображения
	- `imageSmoothingEnabled=false` для 1:1; включать только при масштабировании.
	- Везде предпочитать `createImageBitmap` и своевременно закрывать bitmap.

Продвинутые (больше работ, большой профит)
- OffscreenCanvas + Web Worker для штрихов
	- Перенести построение штрихов и запись в world на worker c OffscreenCanvas; главный поток только композитит.
	- Требует поддержки OffscreenCanvas (Chromium/Electron).
- GPU‑рендерер (WebGL/Pixi.js)
	- Для огромных сцен/экрана — переход на WebGL может дать прирост. Это архитектурно более крупная задача.

Микро‑оптимизации
- Кэшировать transform и не вызывать `setTransform`, если DPR/pan не менялись.
- Минимизировать логи в продакшне (оставить `debug` только под флагом).
- Фон: при статичном фоне — CSS‑background у wrapper либо предрендер в offscreen и последующая композиция.
- Контроль давления событий: если кадр в процессе — пропускать новые батчи (стратегия «latest wins»).

Рекомендуемый порядок внедрения
1) rAF‑present + батчинг/прореживание точек + сглаживание пути для карандаша/ластика.
2) Ограничение DPR до 1.5–2.0 + `alpha:false, desynchronized:true` для видимого canvas.
3) Уменьшить MULT в `world.js`; проверить рост и панорамирование.
4) Dirty‑region композиция (опц.).
5) OffscreenCanvas/Worker при необходимости для 4K и слабых CPU.

Метрика успеха
- Ввод без отставаний при быстрых штрихах, целевой FPS ≥ 55–60 на FullHD/4K.
- Снижение потребления памяти world/shapes на старте (за счёт меньшего MULT и DPR‑cap).

## 11) Изменения — 2025-08-24

Ниже перечислены изменения, внесённые в репозиторий в этот день (кратко):

- `scripts/canvas.menu.js`
	- Переработан пункт Paste: теперь по умолчанию разблокирован и визуально не отключается; клик по пункту гарантированно вызывает `actions.paste()` (прямая инвокация) и пишет диагностические логи (`contextMenu.paste.*`). Асинхронная проверка доступности буфера обмена оставлена для диагностики, но не блокирует UI.

- `scripts/world.js`
	- Добавлен `create2dContext(canvas, wantWillRead)` и внедрён `willReadFrequently: true` при создании offscreen/world/shapes контекстов с безопасным откатом.

- `scripts/canvas.js`
	- Видимый canvas теперь запрашивает 2D контекст с опцией `{ willReadFrequently: true }` в try/catch, чтобы ускорить `getImageData`‑операции там, где это поддерживается.

- `scripts/history.js`
	- При снятии снапшотов world предпочтение отдано контекстам с `willReadFrequently` и добавлен защитный порог `MAX_SNAPSHOT_PIXELS` для экономии памяти.

- `scripts/logger.js`
	- Логирование оставлено гибким: напомнено, что для просмотра debug‑логов нужно включить уровень `debug` (через `IBLogger.setLevel('debug')` или `localStorage`).

- `index.html`
	- Добавлен ранний скрипт нормализации URL‑параметра `doctype`: `spreadsheet -> cell`, `presentation -> slide`, `text -> word`. Это предотвращает ошибку внешнего API, который ожидает `documentType` равным `word/cell/slide`.

Статус: изменения применены и проверены на отсутствие синтаксических ошибок в изменённых файлах. Для отладки Paste откройте DevTools, включите debug‑логирование (`IBLogger.setLevel('debug')`) и выполните правый клик → Paste, затем пришлите консольный вывод при проблемах.

Если нужно, автоматически добавлю пользовательский toast при неудачном paste и расширю логирование в `scripts/tool.image.js` для детального трассинга вставки из буфера обмена — скажите, нужно ли это.
