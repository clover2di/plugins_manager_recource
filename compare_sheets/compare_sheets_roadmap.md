# Roadmap плагина CompareTables

_Обновлено: 2025-08-20_

## 1. Видение
Дать внутри R7.Офис быстрый, точный и понятный инструмент сравнения электронных таблиц: структура, значения, формулы, форматирование, метаданные и удобная навигация/отчётность.

## 2. Цели верхнего уровня
1. Точность — минимум ложных срабатываний.
2. Производительность — линейное масштабирование, быстрый отклик на средних объёмах.
3. Прозрачность — ясные визуальные и текстовые объяснения, воспроизводимые отчёты.
4. Расширяемость — модульные категории, сменные стратегии выравнивания, экспортёры.
5. Надёжность — детерминизм, устойчивость к частичным сбоям API.
6. UX и доступность — локализация, клавиатура, минимальная когнитивная нагрузка.

## 3. Текущее состояние (база)
- Категории: value, formula, formula→value, value→formula, type, (format заглушка), вставка/удаление строк и столбцов (эвристика).
- Импорт файлов + импорт текущей книги; mock режим удалён.
- Отображение diff (превью, сетка, легенда), базовый отчёт.
- Локализация RU (EN частично / требуется актуализация).
- Нет LCS, нет реал. форматного diff, ограниченные метаданные, нет навигации.

## 4. Фазы
| Фаза | Фокус | Результат | Критерий выхода |
|------|-------|-----------|-----------------|
| 1 | Закалка | Ошибки/стабильность, тесты-скелет | Ноль критических падений |
| 2 | Расширение diff | Формат, комментарии, именованные диапазоны | Точность формат ≥95% тест-корпус |
| 3 | Структурный интеллект | LCS строки/столбцы, перемещения блоков | 50k ячеек < 8s |
| 4 | UX | Навигация, подсветка в листе, поиск улучшен | Полная клавиатурная доступность |
| 5 | Продвинутое | Инкрементальное сравнение, JSON schema v1 | Стабильная схема экспорта |

## 5. Приоритезированный бэклог
### P1 (сейчас)
- Форматный diff (числовой формат, шрифт, жирный/курсив, заливка, выравнивание, рамки — сигнатура).
- Панель ошибок (коды + локализованные сообщения).
- JSON экспорт + схема v1.
- Полная RU↔EN паритет локализации.
- Unit тесты базовых категорий.

### P2
- Именованные диапазоны.
- Комментарии.
- Скрытые строки/столбцы.
- Добавленные / удалённые / переименованные листы.
- Прототип LCS по строкам.

### P3
- LCS по столбцам + обнаружение перемещённых блоков.
- Условное форматирование.
- Валидации данных.
- Защита листа/книги.
- Инкрементальный re-run.

### P4
- Навигация diff (next/prev, фильтр по категориям).
- Подсветка в реальном листе (apply/clear).
- Пакетный отчёт по нескольким листам.
- Тёмная тема / адаптивная палитра.
- Runtime переключатель языка.

### P5
- Стриминговый snapshot/diff.
- Памятные лимиты и graceful degrade.
- API расширений (кастомные категории).
- Телеметрия (опционально) производительности.
- Аудит доступности (WCAG 2.1 AA).

## 6. Вехи
| Milestone | Состав | Тест выхода |
|-----------|--------|-------------|
| M1 | Формат + JSON + тесты основ | ≥90% покрытие ядра |
| M2 | Структура+метаданные | <3% неверных структурных сопоставлений |
| M3 | UX пакет | Навигация + подсветка OK |
| M4 | Enterprise | Инкрементальность + схема v1 |
| M5 | Release 1.0 | Ноль high severity дефектов |

## 7. Тех инициативы
1. Рефактор Diff Engine (реестр категорий).
2. Слой выравнивания (стратегии heuristic/LCS/hybrid).
3. Lazy формат: отдельный проход при включённой опции.
4. Кэш: хэш листа (размеры + CRC значений/формул) для пропуска.
5. Отчёт: модульные экспортёры (XLSX/JSON/CSV).
6. Структурированные логи (код, уровень, контекст).

## 8. Эволюция архитектуры
Текущее: монолит скриптов. Цель: `core/` модули (snapshot, alignment, categories, exporters) + узкий фасад `CompareService`.

## 9. Стратегия тестирования
| Слой | Тип тестов | Инструмент |
|------|------------|------------|
| Категории | Unit (value/formula/type/format) | Jest / легк. раннер |
| Выравнивание | Фикстуры синтетика | Snapshot сравнение |
| Производительность | Скрипт таймингов | Node harness |
| UI | Smoke (import/run/export) | Headless (опц.) |
| Локализация | Проверка ключей | Скрипт diff |

## 10. Цели производительности
| Размер (ячейки) | Цель | Примечание |
|------------------|------|-----------|
| 5k | <1s | Мгновенно |
| 20k | <3s | Прогресс видим |
| 50k | <8s | Нужен LCS оптимизирован |
| 100k | Warn / частичный | Предложить отмену |

## 11. Локализация и доступность
- RU/EN паритет.
- Runtime переключатель.
- aria-live для завершения.
- Проверка контраста цветовых фонов diff.

## 12. Dev Experience
- ESLint + Prettier.
- Pre-commit hook (lint+unit subset).
- CONTRIBUTING.md.
- Локальный скрипт запуска Р7.Офис контейнера.

## 13. Риски
| Риск | Влияние | Митигация |
|------|---------|-----------|
| Большие листы (OOM) | Зависание | Стриминг + батчинг |
| Неверное выравнивание | Ложные структуры | LCS + fallback хэши |
| Шум форматного diff | Недоверие | Тонкая настройка полей |
| Медленная инициализация API | Заблок. UX | Таймаут + уведомл. |
| Дрейф локализации | Неполнота UI | Скрипт проверки |
| Контраст в тёмной теме | Нечитаемо | Динамический подбор |

## 14. Метрики
| Метрика | Определение | Цель |
|---------|-------------|------|
| p50 времени сравнения | Старт→результат | В таблице производительности |
| False Positive Rate | Ложные / все diff | <2% |
| Crash Rate | Падения / 100 запусков | 0 blocking |
| Покрытие локализации | Использованные ключи | 100% |
| Test Coverage ядра | Statements diff engine | ≥85% |

## 15. Версионирование
SemVer: MAJOR (слом схемы), MINOR (нов. категории), PATCH (фиксы). Ведение CHANGELOG (Added/Changed/Fixed/Removed).

## 16. Зависимости
- Р7.Офис Asc API (варианты сигнатур callCommand) — матрица совместимости.
- XLSX парсер (ленивая загрузка).
- Лёгкий CRC для хэшей.

## 17. Отложено / вне scope
- Pivot diff.
- Диаграммы.
- Внешние ссылки с сетью.
- Пакетная автоматизация множеств workbook пар.
- Live collaborative diff.

## 18. Чеклист ближайших 2–3 сессий
- [ ] Форматная сигнатура.
- [ ] JSON export + schema v1.
- [ ] Unit тесты (минимум 5 сценариев).
- [ ] Diff именованных диапазонов.
- [ ] Прототип LCS (строки) под флагом.
- [ ] EN локализация синхронизирована.
- [ ] Панель ошибок.

## 19. Открытые вопросы
1. Игнорировать ли мелкие стильные отличия (±1 размер шрифта)?
2. Перемещённые блоки: отдельная категория или связывающие теги между вставкой/удалением?
3. JSON: включать все неизменённые метаданные или только diffs?
4. Нужен ли публичный API для автоматизации? (безопасность / sandbox).

## 20. Глоссарий
- Снимок (snapshot) — модель листа.
- Выравнивание — сопоставление строк/столбцов.
- Категория — тип различия.
- Страйп (stripe) — вторичный визуальный слой для многокатегорийных ячеек.

---
_Документ обновляется после каждой вехи._

## 21. Дополнительные краткосрочные улучшения (быстрые внедрения)
Ниже — список «быстрых побед» (Quick Wins) и небольших инноваций, которые можно встраивать параллельно основным фазам без серьёзного риска архитектуре.

### Исправление текущих ошибок и неточностей
- [QW] Реализация работы синхронного скроллинга, исправление плавности скроллинга.
- [QW] Реализация работы с текущими запущенными таблицами.
- [QW] Улучшение работы фильтров категорий.
- [QW] Улучшенная реализация превью таблиц.
- [QW] Улучшене локализации.

### UX / Интерфейс
- [QW] Авто-подгон ширины колонок diff-грида (минимум/максимум + двойной клик для авто-fit).
- [QW] Фильтр по категориям внутри diff-грида (drop‑down «Показать только…»).
- [QW] Плавающая панель «Сводка» c динамическими счётчиками (закрепляется снизу / сбоку).
- [QW] Копирование строки diff в буфер (иконка «copy»).
- [QW] Быстрая подсветка отличий формулы (символьный diff с цветами внутри всплывающего окошка при наведении).
- [QW] Горячие клавиши: R (run), N/P (next/prev diff), F (toggle search), L (toggle legend).
- [QW] Индикатор «N категорий скрыто» при активных фильтрах.
- [QW] Модальное окно настроек (persist опций, лимиты, включение/выключение форматного diff).
- Интерактивный просмотра «до/после» формулы (split view, бегунок).

### Производительность
- [QW] Ленивый рендер diff-грида (виртуализация списка) для > 5k строк.
- [QW] Веб‑воркер для тяжёлой части сравнения (изолировать UI лаги).
- Предпрогрев: ранний снимок активного листа при простое (если включено).
- Кэш формул/значений по хэшу строк для отката повторных сравнений.

### Точность / Алгоритмы
- [QW] Подсветка различий формул через LCS по токенам (не просто строка).
- [QW] Эвристика «переименование листа» (совпадение контента > X%).
- Нормализация числовых форматов (± локальные разделители) перед сравнением.
- Детекция «обратимого» изменения (формула -> то же значение) с мягкой категорией.

### Отчёты / Экспорт
- [QW] Добавить CSV экспорт (все diff строки).
- [QW] Параметр «ограничить до N строк» при экспорте.
- Отметка времени и hash входных листов в каждом отчёте (репродьюсибилити).
- HTML отчёт (самодостаточный файл) с встраиванием стилей.
- Расширенный XLSX отчёт: лист «Summary», лист «Details», цветовые стили.

### Локализация / Доступность
- [QW] Проверка отсутствующих ключей (скрипт «unused / missing»).
- [QW] ARIA role для diff строк + aria-describedby для подсказок категорий.
- Тема для дальтонизма (альтернативная палитра с различными паттернами).
- Автоматический выбор языка по navigator.language.

### Надёжность / Диагностика
- [QW] Панель «Diagnostics»: версия API, время инициализации, лимиты.
- Логический код ошибок (ERR_SNAPSHOT_TIMEOUT, ERR_FORMAT_HASH_FAIL…).
- Журнал последнего сравнения (in-memory ring buffer + кнопка «Скопировать лог»).

### Dev Experience
- [QW] Скрипт генерации фикстур листов (JSON ↔ XLSX) для тестов.
- Визуальные «сторисы» (мини html harness) для diff-грида и превью.
- Конфигurable build (dev/prod) с отключением подробных логов.

### Инновации / R&D
- Обнаружение «перемещённых диапазонов» через двухэтапный hashing (rolling + anchor match).
- Частичное сравнение «выделенной области» (selection compare mode).
- Авто-рекомендации: «У вас много типов diff X — проверьте форматирование чисел».
- Предиктивный прогресс (оценка оставшегося времени из предыдущей скорости батчей).

### Технический долг (быстро гасимый)
- Унифицировать генерацию tooltip'ов категорий (одна функция + кэш).
- Вынести цветовую схему diff в JSON палитру (будущая смена тем без правки CSS).
- Минимизировать прямой доступ UI к State (ввести методы фасада).

### Критерии завершения блока «краткосрочные»
Выполнено ≥70% задач помеченных [QW] без регрессий по существующим тестам и без роста времени сравнения >5% на контрольных наборах.

---
